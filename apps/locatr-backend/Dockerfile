# This file is generated by Nx.
#
# Build the docker image with `npx nx docker-build locatr-backend`.
# Tip: Modify "docker-build" options in project.json to change docker build args.
#
# Run the container with `docker run -p 3000:3000 -t locatr-backend`.
FROM docker.io/node:lts-alpine

# ENV HOST=0.0.0.0
# ENV PORT=3000

WORKDIR /app

RUN addgroup --system locatr-backend && \
    adduser --system -G locatr-backend locatr-backend

# Copy the .env file to the container
# COPY .env ./locatr-backend/

# Copy the built application files to the container
COPY dist/apps/locatr-backend ./locatr-backend/

# Set permissions
RUN chown -R locatr-backend:locatr-backend ./locatr-backend

# Copy the package files
COPY package*.json pnpm-lock.yaml ./locatr-backend/

# Install pnpm globally and install project dependencies using pnpm
RUN npm install -g pnpm && \
    pnpm --prefix ./locatr-backend install --prod

# Use the non-root user to run the app
USER locatr-backend

# Start the application
CMD [ "node", "locatr-backend/main.js" ]
